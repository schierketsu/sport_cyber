# КИБЕРКАЧАЛКА — полная техническая документация проекта

> **Слоган:** «Играй стабильно. Не выгорай.»  
> **Версия:** 1.0.0+1  
> **Платформа:** Flutter 3.9+, Windows (основная целевая платформа)

---

## Содержание

1. [Введение и концепция](#1-введение-и-концепция)
2. [Архитектура и технологический стек](#2-архитектура-и-технологический-стек)
3. [Структура проекта](#3-структура-проекта)
4. [Модули и функции](#4-модули-и-функции)
5. [Модели данных](#5-модели-данных)
6. [Состояние приложения (AppState)](#6-состояние-приложения-appstate)
7. [Хранение данных](#7-хранение-данных)
8. [Индикатор выгорания](#8-индикатор-выгорания)
9. [Антитильт-режим](#9-антитильт-режим)
10. [Планировщик нагрузки](#10-планировщик-нагрузки)
11. [Wellness-паузы](#11-wellness-паузы)
12. [Тема и UI](#12-тема-и-ui)
13. [Пользовательский сценарий](#13-пользовательский-сценарий)
14. [Запуск и сборка](#14-запуск-и-сборка)
15. [Известные ограничения и будущее развитие](#15-известные-ограничения-и-будущее-развитие)

---

## 1. Введение и концепция

### 1.1 Цель продукта

**КИБЕРКАЧАЛКА** — приложение для киберспортсменов и активных геймеров, которое помогает:

- **Контролировать нагрузку** — отслеживать время игры, сон, перерывы
- **Предотвращать выгорание** — один понятный индикатор риска (зелёный / жёлтый / красный)
- **Снижать тильт** — мягкие рекомендации вместо запретов, предложение пауз и wellness-упражнений

Приложение не занимается прокачкой скилла, сложной аналитикой или интеграцией с API игр. Фокус — на балансе между игрой и здоровьем.

### 1.2 Целевая аудитория

- Киберспортсмены (в т.ч. полупрофессионалы)
- Ранкед-игроки в Dota 2, CS2, Valorant и др.
- Любой активный геймер, заботящийся о стабильной форме

### 1.3 Формат MVP

- **Без API** — всё локально
- **Без ML** — правила индикатора зашиты в код
- **Без Drift/SQLite** — только `shared_preferences`
- **Минимум действий** — один главный экран, один индикатор, одна рекомендация

---

## 2. Архитектура и технологический стек

### 2.1 Общая схема

```
┌─────────────────────────────────────────────────────────────────────┐
│                            UI (Widgets)                              │
│  HomeScreen │ StateScreen │ SettingsScreen │ WellnessScreen │ ...   │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    AppState (ChangeNotifier)                         │
│  Сессии, дни, настройки, индикатор, тильт, wellness-напоминания      │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐
│ AppStorage   │ │ BurnoutInd.  │ │ PauseReminder (таймер +  │
│ (shared_     │ │ (расчёт)     │ │ flutter_local_notif.)    │
│  prefs)      │ │              │ │                          │
└──────────────┘ └──────────────┘ └──────────────────────────┘
```

### 2.2 Технологии

| Компонент | Технология | Версия |
|-----------|------------|--------|
| UI-фреймворк | Flutter | SDK ^3.9.2 |
| Состояние | Provider | ^6.1.2 |
| Хранение | shared_preferences | ^2.2.3 |
| Уведомления | flutter_local_notifications | ^17.2.3 |
| Окно (Windows) | window_manager | ^0.5.1 |
| Шрифты | google_fonts | ^6.2.1 |

### 2.3 Режим окна (Windows)

При запуске на Windows приложение:

- Имеет фиксированный размер **320×200**
- Размещается **поверх всех окон** (always on top)
- Без рамки (frameless)
- Выравнивается в правый нижний угол экрана
- Окно **нельзя изменять по размеру** (resizable = false)

---

## 3. Структура проекта

### 3.1 Дерево файлов

```
sport_cyber/
├── lib/
│   ├── main.dart                 # Точка входа, инициализация окна и провайдеров
│   ├── app.dart                  # MaterialApp, маршруты, вызов антитильт-диалога
│   ├── core/
│   │   ├── constants.dart        # Пороги индикатора, лимиты, константы
│   │   ├── models.dart           # DayRecord, SessionRecord, Mood
│   │   ├── storage.dart          # AppStorage — обёртка над SharedPreferences
│   │   └── theme.dart            # Тёмная тема, отступы, радиусы
│   ├── state/
│   │   └── app_state.dart        # AppState — единый источник состояния
│   ├── home/
│   │   └── home_screen.dart      # Главный экран: старт/стоп, индикатор, кнопки
│   └── features/
│       ├── burnout/
│       │   └── burnout_indicator.dart  # Расчёт BurnoutResult (level, reason, recommendation)
│       ├── tilt/
│       │   └── anti_tilt_screen.dart   # Экран антитильта (в проде вызывается через wellness)
│       ├── planner/
│       │   ├── planner_settings.dart   # Модель PlannerSettings
│       │   └── planner_screen.dart     # Экран настроек планировщика
│       ├── wellness/
│       │   ├── wellness_screen.dart    # Выбор: кисти, шея, спина, глаза (20-20-20)
│       │   ├── exercise_screen.dart    # Упражнение с таймером
│       │   └── pause_reminder.dart     # Таймер сессии + локальные уведомления
│       ├── settings/
│       │   └── settings_screen.dart    # Сон, перерывы, сохранение
│       ├── state/
│       │   └── state_screen.dart       # График каток за день
│       ├── mood/
│       │   └── mood_screen.dart        # Выбор настроения (плохо/норм/хорошо)
│       └── book/
│           └── book_screen.dart        # Гайды: ОСНОВЫ и РАСКИДКИ
├── windows/
│   └── runner/
│       └── resources/             # Изображения: hp (0–4), emoticon, hearts, кнопки
├── pubspec.yaml
├── README.md
└── PROJECT_DOCUMENTATION.md       # Этот файл
```

### 3.2 Маршруты

| Маршрут | Виджет |
|---------|--------|
| `/` (home) | HomeScreen |
| `/settings` | SettingsScreen |
| `/wellness` | WellnessScreen |
| `/state` | StateScreen |

---

## 4. Модули и функции

### 4.1 Модуль 1: Индикатор риска выгорания (CORE)

**Файл:** `lib/features/burnout/burnout_indicator.dart`

- **BurnoutLevel:** `green`, `yellow`, `red`
- **BurnoutResult:** `level`, `reason`, `recommendation`
- Использует: `DayRecord today`, `List<DayRecord> days`, `playHoursThisWeek`, `maxPlayPerDay`

**Логика:**

- Начисление «баллов» по факторам: игра сегодня/неделя, дни подряд, перерывы, настроение, серия поражений
- `score >= 5` → красный
- `score >= 2` → жёлтый
- иначе → зелёный

### 4.2 Модуль 2: Антитильт-режим

**Триггеры:**

- Пользователь нажал «Тильт» на главном экране
- `losingStreak >= 3` и `mood == bad` при завершении сессии

**Поведение:**

- При срабатывании: показ wellness-экрана как модального окна (через `showAntiTiltIfNeeded` в `app.dart`)
- Текст: «Сейчас ты играешь хуже не из-за скилла. Хочешь остановиться и сохранить рейтинг?»
- Вариант «Физическая разрядка» открывает WellnessScreen

### 4.3 Модуль 3: Мини-планировщик нагрузки

**PlannerSettings:**

- `workHoursPerDay` — часы учёбы/работы (null = свободный день)
- `sleepGoalHours` — цель по сну (по умолчанию 7)
- `maxPlayHoursPerDay` — макс. время игры в день (по умолчанию 3)

**Отображение на главном экране:**

- При `played >= limit`: «Лимит X ч — уже Y ч»
- При `0 < remaining <= 0.5 ч`: «Осталось ~Z мин до лимита»

### 4.4 Модуль 4: Wellness-паузы

**Состав:**

- Правило **20-20-20**: 20 секунд смотреть вдаль (объект в 20 м), каждые 20 минут
- Упражнения: **кисти**, **шея**, **спина** — по 45 секунд, описание + таймер
- **Напоминание о паузе** через `flutter_local_notifications` после N минут игровой сессии (по умолчанию 20)

---

## 5. Модели данных

### 5.1 Mood

```dart
enum Mood { bad, ok, good }
```

### 5.2 SessionRecord

```dart
class SessionRecord {
  final int startMinutes;      // Минуты от 00:00
  final int durationMinutes;
  final bool? myPlaySatisfied; // 👍/👎 своей игры
  final bool? teamPlaySatisfied;
  final Mood? mood;
}
```

### 5.3 DayRecord

```dart
class DayRecord {
  final String date;           // yyyy-MM-dd
  final double playHours;
  final double? sleepHours;
  final int breaksCount;
  final Mood? mood;
  final int losingStreak;
  final bool? myPlaySatisfied;
  final bool? teamPlaySatisfied;
  final List<SessionRecord> sessions;
}
```

### 5.4 PlannerSettings

```dart
class PlannerSettings {
  final double? workHoursPerDay;
  final double sleepGoalHours;
  final double maxPlayHoursPerDay;
}
```

---

## 6. Состояние приложения (AppState)

**Класс:** `AppState extends ChangeNotifier`

### 6.1 Основные поля

| Поле | Тип | Описание |
|------|-----|----------|
| `days` | `List<DayRecord>` | История дней |
| `plannerSettings` | `PlannerSettings?` | Настройки планировщика |
| `sessionStart` | `DateTime?` | Время начала текущей сессии |
| `tiltDialogActive` | `bool` | Нужно ли показать антитильт |
| `wellnessReminderVisible` | `bool` | Виден ли баннер wellness-напоминания |
| `wellnessReminderType` | `String` | `neck`, `wrists`, `back`, `eyes` |

### 6.2 Основные методы

| Метод | Назначение |
|-------|------------|
| `startSession()` | Начать игровую сессию |
| `endSession({...})` | Завершить сессию, записать время, настроение, оценку |
| `addPlayHours(double)` | Добавить часы игры вручную |
| `setTodaySleep(double)` | Установить сон за сегодня |
| `setTodayBreaks(int)` | Установить количество перерывов |
| `setTodayMood(Mood)` | Установить настроение |
| `setTodayLosingStreak(int)` | Установить серию поражений |
| `getBurnoutResult()` | Рассчитать BurnoutResult |
| `showTiltDialog()` / `dismissTiltDialog()` | Управление антитильт-диалогом |
| `requestWellnessReminder()` / `dismissWellnessReminder()` | Управление баннером wellness |

---

## 7. Хранение данных

**Класс:** `AppStorage` (обёртка над `SharedPreferences`)

### 7.1 Ключи

| Ключ | Тип | Описание |
|------|-----|----------|
| `planner_settings` | String (JSON) | PlannerSettings |
| `days` | String (JSON array) | Список DayRecord |
| `wellness_reminder_enabled` | bool | Включены ли напоминания |
| `wellness_reminder_minutes` | int | Интервал напоминания (минуты) |

---

## 8. Индикатор выгорания

### 8.1 Константы (constants.dart)

| Константа | Значение | Описание |
|-----------|----------|----------|
| `maxPlayHoursPerDay` | 4.0 | Лимит часов игры в день |
| `maxPlayHoursPerWeek` | 25.0 | Лимит часов за неделю |
| `consecutiveHighLoadDaysThreshold` | 4 | Порог «дней подряд без отдыха» |
| `minSleepHours` | 6.0 | Минимум сна (часов) |
| `criticalSleepHours` | 5.0 | Критически мало сна |
| `minBreaksPerDay` | 2 | Минимум перерывов |
| `losingStreakTiltThreshold` | 3 | Серия поражений для тильта |
| `defaultWellnessReminderMinutes` | 20 | Интервал напоминания |

### 8.2 HP-бар на главном экране

Используются изображения `hp/0.png` … `hp/4.png`:

| Уровень | Условие | Подпись (пример) |
|---------|---------|------------------|
| 0 | Сон &lt; 5 ч | «Только спать!» |
| 1 | BurnoutLevel.green | «Ты в потоке!» |
| 2 | BurnoutLevel.yellow | «Время отдохнуть» |
| 3 | Лузстрик 1–2 или сон+работа | «Средняя форма» |
| 4 | BurnoutLevel.red, mood bad, лузстрик &gt; 3 | «Остановись, отдохни» / «Мигом отдыхать!» |

---

## 9. Антитильт-режим

### 9.1 Триггеры

1. Ручное нажатие кнопки «Тильт» на главном экране
2. При `endSession`: `mood == bad` и `losingStreak >= 3`

### 9.2 Поведение

- `showAntiTiltIfNeeded` в `app.dart` проверяет `tiltDialogActive`
- Открывает `WellnessScreen` как модальное окно (bottom sheet) на весь экран
- Отдельный `AntiTiltScreen` в `features/tilt/` в текущей реализации не используется при автоматическом срабатывании — вместо него сразу показывается wellness

---

## 10. Планировщик нагрузки

### 10.1 Экран

- `PlannerScreen` — экран с полями: часы работы, цель по сну, макс. время игры
- Сохранение в `AppState.setPlannerSettings`

### 10.2 Настройки дня (SettingsScreen)

- Поля: сон за сегодня (ч), перерывы (количество)
- Сохранение через `setTodaySleep`, `setTodayBreaks`, `setPlannerSettings`

---

## 11. Wellness-паузы

### 11.1 WellnessScreen

- 4 плитки: **Кисти**, **Шея**, **Спина**, **Глаза**
- Кисти / шея / спина → `ExerciseScreen` (45 сек, описание)
- Глаза → `Eyes202020Screen` (20 сек, правило 20-20-20)

### 11.2 PauseReminder

- При `startSession` запускается таймер на N минут
- По истечении: вызов `onRemind` (показ баннера) + локальное уведомление
- При `endSession` таймер отменяется

### 11.3 Wellness-баннер

- Появляется поверх главного экрана
- Типы: neck, wrists, back, eyes
- Кнопки: «ПРИСТУПИТЬ» (переход к упражнению) и закрыть

---

## 12. Тема и UI

### 12.1 Тема

- **appDarkTheme** — тёмная тема Material 3
- primary: `#00FF7F` (зелёный)
- surface: `#121212`
- Шрифт: Inter (Google Fonts)

### 12.2 Отступы и радиусы (theme.dart)

| Константа | Значение |
|-----------|----------|
| spacingXs | 4 |
| spacingS | 8 |
| spacingM | 12 |
| spacingL | 16 |
| spacingXl | 24 |
| radiusCard | 12 |
| radiusButton | 12 |
| radiusField | 8 |

### 12.3 Ресурсы

- `hp/0.png` … `hp/4.png` — индикатор HP
- `emoticon/1.png`, `2.png`, `3.png` — настроение
- `greenheart.png`, `yellowheart.png`, `redheart.png`, `deadheart.png`
- `button/start.png`, `button/stop.png`

---

## 13. Пользовательский сценарий

1. **Запуск** → главный экран с HP-индикатором и кнопкой старт/стоп
2. **Начать сессию** → таймер wellness запускается
3. **Завершить сессию** → диалог «Как сыграл ты?» (👍/👎) и «Как сыграла команда?» (👍/👎)
4. После завершения → предложение «Размяться?» → WellnessScreen
5. **Тильт** → кнопка «Тильт» или автозапуск при плохом настроении + лузстрик → wellness
6. **Настройки** → сон, перерывы, сохранение
7. **Катки за день** → тап по индикатору → график сессий, тап по полоске — детали
8. **Гайды** → ОСНОВЫ и РАСКИДКИ (заглушки)
9. **Wellness-напоминание** → баннер поверх экрана → выбор упражнения

---

## 14. Запуск и сборка

### 14.1 Требования

- Flutter SDK 3.9.2+
- Visual Studio с нагрузкой «Разработка классических приложений на C++» (для Windows)

### 14.2 Команды

```bash
# Установка зависимостей
flutter pub get

# Запуск на Windows
flutter run -d windows

# Сборка релиза
flutter build windows
```

### 14.3 Тесты

```bash
flutter test
```

---

## 15. Известные ограничения и будущее развитие

### 15.1 Текущие ограничения

- **Только Windows** в качестве основной платформы (размер окна и always on top настроены только для Windows)
- **Нет настройки wellness-напоминаний в UI** — `setWellnessReminderEnabled` и `setWellnessReminderMinutes` есть в AppState, но экран настроек их не использует
- **Гайды** — заглушки, без реального контента
- **PlannerScreen** — не открывается с главного экрана (только через настройки планировщика, если маршрут добавлен)

### 15.2 Возможные улучшения

- Добавить экран настроек wellness-напоминаний (интервал, вкл/выкл)
- Расширить AntiTiltScreen: 10 мин перерыв, разбор ошибок, завершить сессию
- Поддержка Android/iOS (адаптация окна)
- Экспорт данных
- Более гибкая настройка порогов индикатора (конфиг/настройки)

---

*Документ составлен на основе анализа кодовой базы проекта КИБЕРКАЧАЛКА.*
